---
// ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ãŒæ·±ããªã‚‹ç‚¹ã«æ³¨æ„
import Topbar from '../../../../components/topbar.astro';
import Layout from '../../../../layouts/blogLayout.astro';
import BlogImage from '../../../../components/blog-image.astro';
import Pagination from '../../../../components/pagination.astro'; 
import BlogLine from '../../../../components/blog-line.astro';

interface Post {
  frontmatter: {
    title?: string;
    date?: string;
    tags?: string[];
    custom_excerpt?: string;
    published?: boolean;
  };
  rawContent: () => Promise<string> | string;
  file: string;
}

interface PageData {
  currentPage: number;
  lastPage: number;
  url: {
    prev: string | undefined;
    next: string | undefined;
  };
  data: Array<{
    frontmatter: {
      title?: string;
      date?: string;
      tags?: string[];
    };
    file?: string;
    excerpt?: string;
  }>;
}

export async function getStaticPaths({ paginate }) {
  try {
    // 1. ã™ã¹ã¦ã®ãƒ–ãƒ­ã‚°æŠ•ç¨¿ã‚’å–å¾—
    const posts = await import.meta.glob<Post>('/src/content/posts/*.md', { eager: true });
    const postEntries = Object.entries(posts);
    
    // 2. frontmatterã‹ã‚‰ã™ã¹ã¦ã®ã‚¿ã‚°ã‚’é‡è¤‡ãªãåé›†ã™ã‚‹
    const allTags = new Set<string>();
    postEntries.forEach(([_, post]) => {
      if (post.frontmatter.tags && Array.isArray(post.frontmatter.tags)) {
        post.frontmatter.tags.forEach(tag => allTags.add(tag));
      }
    });

    // 3. å„ã‚¿ã‚°ã”ã¨ã«ãƒšãƒ¼ã‚¸ã‚’ç”Ÿæˆã™ã‚‹
    const paths = [];
    
    for (const tag of allTags) {
      // ç¾åœ¨ã®ã‚¿ã‚°ãŒå«ã¾ã‚Œã‚‹æŠ•ç¨¿ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const filteredPosts = postEntries
        .map(([_, post]) => post)
        .filter(post => post.frontmatter.tags?.includes(tag as string));

      // æŠœç²‹å‡¦ç†
      const postsWithExcerpts = await Promise.all(
        filteredPosts.map(async (post, index) => {
          let excerpt = '';
          
          try {
            if (post.frontmatter?.custom_excerpt) {
              excerpt = post.frontmatter.custom_excerpt;
            } else {
              let content = '';
              if (post.rawContent) {
                if (typeof post.rawContent === 'function') {
                  content = await post.rawContent();
                } else {
                  content = post.rawContent;
                }
              }
              
              if (content) {
                // Markdownã®è¨˜æ³•ã‚„æ”¹è¡Œã‚’é™¤å»ã—ã¦ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«è¿‘ã¥ã‘ã‚‹
                const plainText = content
                  .replace(/#+\s/g, '')        // è¦‹å‡ºã—è¨˜å· (#) ã‚’é™¤å»
                  .replace(/<br\s*\/?>/gi, ' ') // <br> ã‚¿ã‚°ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«å¤‰æ›
                  .replace(/\r\n|\n|\r/g, ' ') // æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«å¤‰æ›
                  .replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1') // Markdownãƒªãƒ³ã‚¯ã‚’ãƒ†ã‚­ã‚¹ãƒˆã«
                  .replace(/!\[([^\]]*)\]\([^\)]+\)/g, '')  // Markdownç”»åƒã‚’ç©ºã«
                  .replace(/`/g, '')           // ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆã‚’é™¤å»
                  .replace(/\*|_/g, '')        // å¼·èª¿è¡¨ç¾ã®è¨˜å·ã‚’é™¤å»
                  .replace(/\s+/g, ' ')        // é€£ç¶šã™ã‚‹ç©ºç™½ã‚’1ã¤ã«ã¾ã¨ã‚ã‚‹
                  .replace(/\{:\s*\.blog-link\s*\}/g, '')  // {: .blog-link } ã‚’é™¤å»
                  .replace(/<[^>]+>/g, '')     // HTMLã‚¿ã‚°ã‚’ã™ã¹ã¦é™¤å»
                  .trim();

                const moreTag = '<!--more-->';
                const moreIndex = plainText.indexOf(moreTag);
                if (moreIndex !== -1) {
                  excerpt = plainText.substring(0, moreIndex).trim();
                } else {
                  excerpt = plainText.substring(0, 150);
                  if (plainText.length > 150) {
                    excerpt += '...';
                  }
                }
              } else {
                excerpt = `æŠ•ç¨¿${index + 1}ã®æŠœç²‹ã§ã™ã€‚`;
              }
            }
          } catch (error) {
            excerpt = 'æŠœç²‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
          }
          
          return {
            ...post,
            excerpt
          };
        })
      );

      // æœ‰åŠ¹ãªæŠ•ç¨¿ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const validPosts = postsWithExcerpts.filter(post => 
        post.frontmatter?.title && post.frontmatter?.date && post.frontmatter?.published !== false
      );

      // æŠ•ç¨¿ã‚’æ—¥ä»˜ã®æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
      const sortedPosts = validPosts.sort((a, b) =>
        new Date(b.frontmatter.date).getTime() - new Date(a.frontmatter.date).getTime()
      );

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨ã‚½ãƒ¼ãƒˆãŒå®Œäº†ã—ãŸæŠ•ç¨¿ãƒªã‚¹ãƒˆã§ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
      const paginatedPosts = paginate(sortedPosts, {
        params: { tag },
        pageSize: 5,
      });

      // å„ãƒšãƒ¼ã‚¸ã®ãƒ‘ã‚¹ã‚’è¿½åŠ 
      paths.push(...paginatedPosts);
    }
    
    return paths;
    
  } catch (error) {
    // ç·Šæ€¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    return paginate([{
      file: '/error.md',
      frontmatter: {
        title: 'ã‚¨ãƒ©ãƒ¼ç”¨ãƒ€ãƒŸãƒ¼æŠ•ç¨¿',
        date: '1970-01-01',
        tags: ['error']
      },
      excerpt: 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'
    }], { 
      params: { tag: 'error' },
      pageSize: 5 
    });
  }
}

// ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå´ã®ãƒ­ã‚°
console.log('=== ã‚¿ã‚°ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè¡Œé–‹å§‹ ===');
console.log('å—ä¿¡ã—ãŸAstro.props:', {
  type: typeof Astro.props,
  keys: Object.keys(Astro.props || {}),
  stringified: JSON.stringify(Astro.props, null, 2)
});

const { page } = Astro.props as { page: PageData };
const { tag } = Astro.params;

if (page) {
  console.log('âœ… pageã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ­£å¸¸å—ä¿¡:', {
    currentPage: page.currentPage,
    lastPage: page.lastPage,
    dataLength: page.data?.length,
    urlKeys: page.url ? Object.keys(page.url) : [],
    firstDataSample: page.data?.[0] ? {
      title: page.data[0].frontmatter?.title,
      file: page.data[0].file
    } : null
  });
} else {
  console.error('âŒ pageã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæœªå®šç¾©');
}
---

<Layout pageTitle={`ã‚¿ã‚°: ${tag}`}>
  <Topbar />
  <BlogImage />
  <article>
    <div class="blog-content">
      <div class="tag-head">
        <div class="tag-pankuzu">
          <a href="/blog">Top</a> &gt;&gt; <a href="">{tag}</a>
        </div>
        <div class="tag-itirann">
          <span><strong><font color="#ff7f7e">#</font>{tag} ã®è¨˜äº‹ã®ä¸€è¦§</strong></span>
        </div>
      </div>
      <div class="blog-tag-line"></div>
      
        {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
        {page && page.data && page.data.length > 0 ? (
          <>
            {page.data.map((post, index) => {
              const filename = post.file?.split('/').pop()?.replace('.md', '') || `post-${index}`;
              
              return (
                <article class="blog-post" key={index}>
                  <header>
                    <h2>
                      <a href={`/blog/${filename}`}>
                        {post.frontmatter?.title || `ç„¡é¡Œã®æŠ•ç¨¿ ${index + 1}`}
                      </a>
                    </h2>
                    <div class="meta">
                      {post.frontmatter?.tags && post.frontmatter.tags.length > 0 && (
                        <div class="tags">
                          {post.frontmatter.tags.map((tag, tagIndex) => (
                            <span key={tagIndex}>
                              <a href={`/blog/tag/${encodeURIComponent(tag)}`} class="post-tag">
                                <span style="color: #ff7f7e;">#</span>{tag}
                              </a>
                              {tagIndex < post.frontmatter.tags.length - 1 && ', '}
                            </span>
                          ))}
                        </div>
                      )}
                      <time class="date">{post.frontmatter?.date || 'æ—¥ä»˜ä¸æ˜'}</time>
                    </div>
                  </header>
                  
                  {post.excerpt && (
                    <p class="excerpt">{post.excerpt}</p>
                  )}
                  
                  <footer>
                    <a href={`/blog/${filename}`} class="read-more">ç¶šãã‚’èª­ã‚€</a>
                  </footer>
                </article>
              );
            })}
          </>
        ) : (
          <div style="text-align: center; padding: 2rem;">
            <p>ğŸ“ ç¾åœ¨ã€è¡¨ç¤ºã§ãã‚‹æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
          </div>
        )}
      </div>
      <BlogLine />
      <Pagination page={page} />
    </article>

    <style>
      .tag-pankuzu {
        font-size: 0.95rem;
      }
      .tag-pankuzu a {
        color: #666;
        text-decoration: none;
      }
      .tag-itirann {
        margin-top: 10px;
      }
      .tag-itirann span {
        font-size: 1.1em;
      }
      .blog-tag-line {
        width: 100%;
        height: 1px;
        background-color: #888;
        margin: 30px auto 30px;
      }
      .blog-content {
        margin: 40px auto 30px;
        width: 70%;
      }
    
      .blog-post {
        margin: 2rem auto;
        width: 100%;
      }
    
      .blog-post h2 {
        text-align: center;
      }
    
      .blog-post h2 a {
        color: black;
        text-decoration: none;
        background: linear-gradient(currentcolor, currentcolor) left bottom / 100% 2px no-repeat,
        linear-gradient(#f6d893, #f6d893) right 60% / 0 .8em no-repeat;
        transition: background-size .4s cubic-bezier(0.215, 0.61, 0.355, 1);
      }
      .blog-post h2 a:hover {
        background-position: right bottom, left 60%;
        background-size: 0 2px, 100% .8em;
      }
      @media (pointer: none) { /* ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ã§ã¯ãƒ›ãƒãƒ¼åŠ¹æœã‚’ç„¡åŠ¹åŒ– */
        .post-title {
          color: black;
          text-decoration: none;
          border-bottom: solid 2px black;
          background: none;
          transition: none;
        }
        .post-title:hover {
          background-position: initial;
          background-size: initial;
        }
      }
      .meta {
        margin-bottom: .5rem;
        font-size: 0.9rem;
        color: #666;
        gap: 1rem;
      }
      
      .tags {
        color: #666;
        margin-top: 1em;
        text-align: center;
      }
      .tags a {
        font-size: .95rem;
        color: #666;
        margin-top: 1em;
        text-align: center;
        text-decoration: none;
      }
      .tags a:hover {
        text-decoration: underline;
      }
      .date {
        font-size: 0.9rem;
        color: #666;
        text-align: left;
      }
      
      .excerpt {
        margin: .5rem 0 0;
        line-height: 1.6;
        color: #222;
      }
    
      .read-more {
        display: inline-block;
        margin-top: 0.8em;
        color: #0066cc;
        text-decoration: none;
      }
      .read-more:hover {
        text-decoration: underline;
      }
    
    @media (max-width: 767px) {
      .blog-content{
        width: 90%;
      }
    }
    </style>
  </Layout>
