---
import { getCollection } from 'astro:content';
import { addExcerpts } from '../../../../utils/generateExcerpt.js';
import Layout from '../../../../layouts/blogLayout.astro';
import Topbar from '../../../../components/topbar.astro';
import { Image } from 'astro:assets';
import pankuzuIcon from '../../../../assets/images/pankuzu.svg';
import BlogImage from '../../../../components/blog-image.astro';
import BlogPostCard from '../../../../components/blog-post-card.astro';
import BlogLine from '../../../../components/blog-line.astro';
import Pagination from '../../../../components/pagination.astro';


export async function getStaticPaths({ paginate }) {
  try {
    const allPosts = await getCollection('posts', ({ data }) => {
      return data.published !== false;
    });
    
    // すべてのタグを収集
    const allTags = [...new Set(allPosts.flatMap((post) => post.data.tags ?? []))];
    
    // 各タグごとにページを生成
    const paths = [];
    
    for (const tag of allTags) {
      // 現在のタグが含まれる投稿のみをフィルタリング
      const filteredPosts = allPosts.filter(post => 
        post.data.tags?.includes(tag)
      );
    
      // excerptを生成
      const postsWithExcerpt = addExcerpts(filteredPosts);

      // 日付でソート
      const sortedPosts = postsWithExcerpt.sort((a, b) => {
        const dateA = new Date(a.data.date).getTime();
        const dateB = new Date(b.data.date).getTime();
        return dateB - dateA;
      });
      
      // ページネーション実行
      const paginatedPosts = paginate(sortedPosts, {
        params: { tag },
        pageSize: 5,
      });
      
      paths.push(...paginatedPosts);
    }
    
    return paths;
    
  } catch (error) {
    console.error('エラーの詳細:', {
      message: error.message,
      stack: error.stack?.split('\n').slice(0, 5)
    });
    // エラー用投稿
    return paginate([{
      id: 'error',
      data: {
        title: 'エラー用ダミー投稿',
        date: '1970-01-01',
        tags: ['error']
      },
      excerpt: 'システムエラーが発生しました。'
    }], { 
      params: { tag: 'error' },
      pageSize: 5 
    });
  }
}

const { page } = Astro.props;
const { tag } = Astro.params;

// OGP用
const ogTitle = `タグ: ${tag}`;
const ogDescription = "書く、これしか出来ないから";
const ogUrl = new URL(Astro.url.pathname, Astro.site).toString();
---

<Layout 
  pageTitle={`タグ: ${tag}`}
  ogTitle={ogTitle} 
  ogDescription={ogDescription} 
  ogUrl={ogUrl}
>
  <Topbar />
  <BlogImage />
  <article>
      <div class="tag-head">
        <div class="tag-pankuzu">
          <a href="/blog">Top</a>
          <Image src={pankuzuIcon} alt="" />
          <a href={`/blog/tag/${encodeURIComponent(tag)}`}>{tag}</a>
        </div>
        <div class="tag-itirann">
          <span><strong><font color="#ff7f7e">#</font>{tag} の記事の一覧</strong></span>
        </div>
      </div>
      
      <BlogLine />
      
    <div class="blog-content">
      {page && page.data ? (
        <>
        {page.data.map((post, index) => {
          const slug = post.id.replace(/\.md$/, '').replace(/^\d{4}-\d{2}-\d{2}-/, '');
          const title = post.data?.title || `無題の投稿 ${index + 1}`;
          const tags = post.data.tags ?? [];
          const date = post.data.date;
  
          return (
            <BlogPostCard 
              slug={slug}
              title={title}
              tags={tags}
              date={date}
              excerpt={post.excerpt}
            />
          );
        })}
      </>
      ) : (
        <div style="text-align: center; padding: 2rem;">
          <p>現在、表示できる投稿がありません</p>
        </div>
      )}
    </div>
    <BlogLine />
    <Pagination page={page} />
  </article>
</Layout>

<style>
  .tag-head {
    margin: 30px auto;
    width: 70%;
  }
  .tag-pankuzu {
    font-size: 1rem;
    color: var(--meta);
  }
  .tag-pankuzu a {
    position: relative;
    padding: 2px 4px;
    color: var(--meta);
    text-decoration: none;
    transition: all 0.3s ease;
  }
  .tag-pankuzu a::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 2px;
    background-color: var(--meta);
    transform: scaleY(0.5);
    transform-origin: bottom;
    transition: width 0.3s ease;
  }
  .tag-pankuzu a:hover::before {
    width: 100%;
  }
  .tag-pankuzu img {
    width: 10px;
    height: 10px;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-user-drag: none;
    -khtml-user-drag: none;
    -moz-user-drag: none;
    -o-user-drag: none;
  }
  .tag-itirann {
    margin-top: 10px;
    color: var(--bg-gyaku);
    font-size: 1.2rem;
  }
  .blog-content {
    margin: 40px auto 30px;
    width: 70%;
  }
  @media (max-width: 767px) {
    .tag-head, .blog-content {
      width: 90%;
    }
  }
</style>