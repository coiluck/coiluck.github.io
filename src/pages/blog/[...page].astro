---
import { getCollection } from 'astro:content';
import { addExcerpts } from '../../utils/generateExcerpt.js';
import Layout from '../../layouts/blogLayout.astro';
import Topbar from '../../components/topbar.astro';
import BlogImage from '../../components/blog-image.astro';
import BlogPostCard from '../../components/blog-post-card.astro';
import BlogLine from '../../components/blog-line.astro';
import Pagination from '../../components/pagination.astro';

export async function getStaticPaths({ paginate }) {
  try {
    // Content Collectionから取得
    const allPosts = await getCollection('posts', ({ data }) => {
      return data.published !== false;
    });
    
    // 各投稿のexcerptを生成
    const postsWithExcerpt = addExcerpts(allPosts);

    // 日付でソート
    const sortedPosts = postsWithExcerpt.sort((a, b) => {
      const dateA = new Date(a.data.date).getTime();
      const dateB = new Date(b.data.date).getTime();
      return dateB - dateA;
    });
    
    // ページネーション実行
    const paginatedResult = paginate(sortedPosts, { pageSize: 5 });
    return paginatedResult;
    
  } catch (error) {
    console.error('エラーの詳細:', {
      message: error.message,
      stack: error.stack?.split('\n').slice(0, 5)
    });
    // エラー用投稿
    return paginate([{
      id: 'error',
      data: {
        title: 'エラー用ダミー投稿',
        date: '1970-01-01'
      },
      excerpt: 'システムエラーが発生しました。'
    }], { pageSize: 5 });
  }
}

const { page } = Astro.props;

// OGP用
const ogTitle = "blog";
const ogDescription = "書く、これしか出来ないから";
const ogUrl = new URL(Astro.url.pathname, Astro.site).toString();
---

<Layout 
  pageTitle="blog" 
  ogTitle={ogTitle} 
  ogDescription={ogDescription} 
  ogUrl={ogUrl}
>
  <Topbar />
  <BlogImage />
  <article>
    <div class="blog-content">
      {page && page.data ? (
        <>
        {page.data.map((post, index) => {
          const slug = post.id.replace(/\.md$/, '').replace(/^\d{4}-\d{2}-\d{2}-/, '');
          const title = post.data?.title || `無題の投稿 ${index + 1}`;
          const tags = post.data.tags ?? [];
          const date = post.data.date;
  
          return (
            <BlogPostCard 
              slug={slug}
              title={title}
              tags={tags}
              date={date}
              excerpt={post.excerpt}
            />
          );
        })}
      </>
      ) : (
        <div style="text-align: center; padding: 2rem;">
          <p>現在、表示できる投稿がありません</p>
        </div>
      )}
    </div>
    <BlogLine />
    <Pagination page={page} />
  </article>
</Layout>

<style>
  .blog-content {
    margin: 40px auto 30px;
    width: 70%;
  }

  @media (max-width: 767px) {
    .blog-content{
      width: 90%;
    }
  }
</style>