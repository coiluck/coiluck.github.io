---
import Topbar from '../../components/topbar.astro';
import Layout from '../../layouts/Layout.astro';
import BlogImage from '../../components/blog-image.astro';
import Pagination from '../../components/pagination.astro'; 
import BlogLine from '../../components/blog-line.astro';

export async function getStaticPaths({ paginate }) {
  console.log('=== getStaticPaths é–‹å§‹ ===');
  
  try {
    const AllPosts = await Astro.glob('../../content/posts/*.md');
    console.log('åŸºæœ¬ãƒ‘ã‚¹ã§å–å¾—ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°:', AllPosts.length);
    
    // ã‚‚ã—ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€ã‚ˆãã‚ã‚‹ä»–ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚è©¦ã™
    let posts = AllPosts;
    if (posts.length === 0) {
      console.log('âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚åˆ¥ã®ãƒ‘ã‚¹ã‚’è©¦è¡Œä¸­...');
      
      try {
        // ãƒ‘ã‚¿ãƒ¼ãƒ³1: srcåŸºæº–
        const posts1 = await Astro.glob('/src/content/posts/*.md');
        console.log('ãƒ‘ã‚¿ãƒ¼ãƒ³1 (/src/...):', posts1.length, 'ä»¶');
        if (posts1.length > 0) posts = posts1;
      } catch (e) {
        console.log('ãƒ‘ã‚¿ãƒ¼ãƒ³1ã§ã‚¨ãƒ©ãƒ¼:', e.message);
      }
      if (posts.length === 0) {
        try {
          // ãƒ‘ã‚¿ãƒ¼ãƒ³2: ç›¸å¯¾ãƒ‘ã‚¹çŸ­ç¸®ç‰ˆ
          const posts2 = await Astro.glob('../content/posts/*.md');
          console.log('ãƒ‘ã‚¿ãƒ¼ãƒ³2 (../content/...):', posts2.length, 'ä»¶');
          if (posts2.length > 0) posts = posts2;
        } catch (e) {
          console.log('ãƒ‘ã‚¿ãƒ¼ãƒ³2ã§ã‚¨ãƒ©ãƒ¼:', e.message);
        }
      }
    }
    // éå…¬é–‹è¨˜äº‹ã‚’é™¤å¤–
    posts = posts.filter(post => post.frontmatter?.published !== false);

    console.log('æœ€çµ‚çš„ã«å–å¾—ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°:', posts.length);

    // æŠœç²‹å‡¦ç†
    console.log('=== æŠœç²‹å‡¦ç†é–‹å§‹ ===');
    const postsWithExcerpts = await Promise.all(
      posts.map(async (post, index) => {
        let excerpt = ''; 
    
    try {
      if (post.frontmatter?.custom_excerpt) {
        excerpt = post.frontmatter.custom_excerpt;
      } else {
        let content = '';
        if (post.rawContent) {
          if (typeof post.rawContent === 'function') {
            content = await post.rawContent();
          } else {
            content = post.rawContent;
          }
        }
        
        if (content) {
          // Markdownã®è¨˜æ³•ã‚„æ”¹è¡Œã‚’é™¤å»ã—ã¦ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«è¿‘ã¥ã‘ã‚‹
          const plainText = content
            .replace(/#+\s/g, '')        // è¦‹å‡ºã—è¨˜å· (#) ã‚’é™¤å»
            .replace(/<br\s*\/?>/gi, ' ') // <br> ã‚¿ã‚°ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«å¤‰æ›
            .replace(/\r\n|\n|\r/g, ' ') // æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«å¤‰æ›
            .replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1') // Markdownãƒªãƒ³ã‚¯ã‚’ãƒ†ã‚­ã‚¹ãƒˆã«
            .replace(/!\[([^\]]*)\]\([^\)]+\)/g, '')  // Markdownç”»åƒã‚’ç©ºã«
            .replace(/`/g, '')           // ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆã‚’é™¤å»
            .replace(/\*|_/g, '')        // å¼·èª¿è¡¨ç¾ã®è¨˜å·ã‚’é™¤å»
            .replace(/\s+/g, ' ')        // é€£ç¶šã™ã‚‹ç©ºç™½ã‚’1ã¤ã«ã¾ã¨ã‚ã‚‹
            .replace(/\{:\s*\.blog-link\s*\}/g, '')  // {: .blog-link } ã‚’é™¤å»
            .replace(/<[^>]+>/g, '')     // HTMLã‚¿ã‚°ã‚’ã™ã¹ã¦é™¤å»
            .trim();

          const moreTag = '<!--more-->';
          const moreIndex = plainText.indexOf(moreTag);
          if (moreIndex !== -1) {
            excerpt = plainText.substring(0, moreIndex).trim();
          } else {
            excerpt = plainText.substring(0, 150); // .trim()ã¯ä¸è¦
            if (plainText.length > 150) {
                excerpt += '...';
            }
          }
        } else {
          excerpt = `æŠ•ç¨¿${index + 1}ã®æŠœç²‹ã§ã™ã€‚`;
        }
      }
    } catch (error) {
      console.error(`æŠœç²‹å‡¦ç†ã‚¨ãƒ©ãƒ¼ (${post.frontmatter?.title}):`, error.message);
      excerpt = 'æŠœç²‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
    }
    
    return {
      ...post,
      excerpt
    };
      })
    );
    
    // æœ‰åŠ¹ãªæŠ•ç¨¿ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const validPosts = postsWithExcerpts.filter(post => 
      post.frontmatter?.title && post.frontmatter?.date
    );
    
    console.log('æœ‰åŠ¹ãªæŠ•ç¨¿æ•°:', validPosts.length);
    
    // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
    const sortedPosts = validPosts.sort((a, b) => {
      const dateA = new Date(a.frontmatter.date).getTime();
      const dateB = new Date(b.frontmatter.date).getTime();
      return dateB - dateA;
    });
    
    console.log('ã‚½ãƒ¼ãƒˆå¾Œã®æŠ•ç¨¿:', sortedPosts.map(p => ({
      title: p.frontmatter.title,
      date: p.frontmatter.date,
      excerptLength: p.excerpt?.length || 0
    })));
    
    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    console.log('=== ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ ===');
    const paginatedResult = paginate(sortedPosts, { pageSize: 5 });
    
    console.log('ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³çµæœ:', {
      totalPages: paginatedResult.length,
      firstPageData: paginatedResult[0] ? {
        paramsType: typeof paginatedResult[0].params,
        params: paginatedResult[0].params,
        propsType: typeof paginatedResult[0].props,
        propsKeys: paginatedResult[0].props ? Object.keys(paginatedResult[0].props) : [],
        pageDataLength: paginatedResult[0].props?.page?.data?.length
      } : null
    });
    
    console.log('=== getStaticPaths å®Œäº† ===');
    return paginatedResult;
    
  } catch (error) {
    console.error('âŒ getStaticPaths è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼:', error);
    console.error('ã‚¨ãƒ©ãƒ¼ã®è©³ç´°:', {
      message: error.message,
      stack: error.stack?.split('\n').slice(0, 5)
    });
    
    // ç·Šæ€¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    return paginate([{
      file: '/error.md',
      frontmatter: {
        title: 'ã‚¨ãƒ©ãƒ¼ç”¨ãƒ€ãƒŸãƒ¼æŠ•ç¨¿',
        date: '1970-01-01'
      },
      excerpt: 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'
    }], { pageSize: 5 });
  }
}

// ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå´ã®ãƒ­ã‚°
console.log('=== ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè¡Œé–‹å§‹ ===');
console.log('å—ä¿¡ã—ãŸAstro.props:', {
  type: typeof Astro.props,
  keys: Object.keys(Astro.props || {}),
  stringified: JSON.stringify(Astro.props, null, 2)
});

const { page } = Astro.props;

if (page) {
  console.log('âœ… pageã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ­£å¸¸å—ä¿¡:', {
    currentPage: page.currentPage,
    lastPage: page.lastPage,
    dataLength: page.data?.length,
    urlKeys: page.url ? Object.keys(page.url) : [],
    firstDataSample: page.data?.[0] ? {
      title: page.data[0].frontmatter?.title,
      file: page.data[0].file
    } : null
  });
} else {
  console.error('âŒ pageã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæœªå®šç¾©');
}
---

<Layout pageTitle="blog">
  <Topbar />
  <BlogImage />
  <article>
    <div class="blog-content">
      {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      {page && page.data && page.data.length > 0 ? (
        <>
          {page.data.map((post, index) => {
            const filename = post.file?.split('/').pop()?.replace('.md', '') || `post-${index}`;
            
            return (
              <article class="blog-post" key={index}>
                <header>
                  <h2>
                    <a href={`/blog/${filename}`}>
                      {post.frontmatter?.title || `ç„¡é¡Œã®æŠ•ç¨¿ ${index + 1}`}
                    </a>
                  </h2>
                  <div class="meta">
                    {post.frontmatter?.tags && post.frontmatter.tags.length > 0 && (
                      <div class="tags">
                        {post.frontmatter.tags.map((tag, tagIndex) => (
                          <span key={tagIndex}>
                            <a href={`/blog/tag/${encodeURIComponent(tag)}`} class="post-tag">
                              <span style="color: #ff7f7e;">#</span>{tag}
                            </a>
                            {tagIndex < post.frontmatter.tags.length - 1 && ', '}
                          </span>
                        ))}
                      </div>
                    )}
                    <time class="date">{post.frontmatter?.date || 'æ—¥ä»˜ä¸æ˜'}</time>
                  </div>
                </header>
                
                {post.excerpt && (
                  <p class="excerpt">{post.excerpt}</p>
                )}
                
                <footer>
                  <a href={`/blog/${filename}`} class="read-more">ç¶šãã‚’èª­ã‚€</a>
                </footer>
              </article>
            );
          })}
        </>
      ) : (
        <div style="text-align: center; padding: 2rem;">
          <p>ğŸ“ ç¾åœ¨ã€è¡¨ç¤ºã§ãã‚‹æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        </div>
      )}
    </div>
    <BlogLine />
    <Pagination page={page} />
  </article>
</Layout>

<style>
  .blog-content {
    margin: 40px auto 30px;
    width: 70%;
  }

  .blog-post {
    margin: 2rem auto;
    width: 100%;
  }

  .blog-post h2 {
    text-align: center;
  }

  .blog-post h2 a {
    color: black;
    text-decoration: none;
    background: linear-gradient(currentcolor, currentcolor) left bottom / 100% 2px no-repeat,
		linear-gradient(#f6d893, #f6d893) right 60% / 0 .8em no-repeat;
    transition: background-size .4s cubic-bezier(0.215, 0.61, 0.355, 1);
  }
  .blog-post h2 a:hover {
    background-position: right bottom, left 60%;
    background-size: 0 2px, 100% .8em;
  }
  @media (pointer: none) { /* ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ã§ã¯ãƒ›ãƒãƒ¼åŠ¹æœã‚’ç„¡åŠ¹åŒ– */
    .post-title {
      color: black;
      text-decoration: none;
      border-bottom: solid 2px black;
      background: none;
      transition: none;
    }
    .post-title:hover {
      background-position: initial;
      background-size: initial;
    }
  }
  .meta {
    margin-bottom: .5rem;
    font-size: 0.9rem;
    color: #666;
    gap: 1rem;
  }
  
  .tags {
    color: #666;
    margin-top: 1em;
    text-align: center;
  }
  .tags a {
    font-size: .95rem;
    color: #666;
    margin-top: 1em;
    text-align: center;
    text-decoration: none;
  }
  .tags a:hover {
    text-decoration: underline;
  }
  .date {
    font-size: 0.9rem;
    color: #666;
    text-align: left;
  }
  
  .excerpt {
    margin: .5rem 0 0;
    line-height: 1.6;
    color: #222;
  }

  .read-more {
    display: inline-block;
    margin-top: 0.8em;
    color: #0066cc;
    text-decoration: none;
  }
  .read-more:hover {
    text-decoration: underline;
  }

@media (max-width: 767px) {
  .blog-content{
    width: 90%;
  }
}
</style>